# Anti-Malware Protection

## Overview

The Security Hardening LSM includes kernel-level anti-malware detection capabilities designed to stop common malware behaviors at the system call level. Unlike traditional antivirus that relies on signatures, this module detects behavioral patterns typical of ransomware, cryptominers, and other malware.

## Features

### Ransomware Detection

The module detects and blocks ransomware through multiple behavioral indicators:

**File Operation Monitoring**
- Tracks rapid file modifications (20+ files in 5 seconds)
- Detects mass file renaming operations
- Identifies high-entropy writes (encrypted content)
- Blocks suspicious file extensions (.encrypted, .locked, etc.)

**Protection Levels**
- **LOW/MEDIUM**: Warns about suspicious activity
- **HIGH/CRITICAL**: Blocks suspected ransomware operations
- **PARANOID**: Maximum protection with strict thresholds

### Cryptominer Detection

Identifies cryptocurrency mining activity:
- Known miner process names (xmrig, minerd, etc.)
- High CPU usage patterns
- Network connections to mining pools
- Suspicious resource consumption

### Execution Control

Prevents malware execution through:
- Blocking execution from temporary directories (/tmp, /dev/shm)
- Detecting hidden executable files
- Monitoring interpreter abuse (bash/python spawning many processes)
- Tracking suspicious parent-child process relationships

### Fileless Malware Prevention

Detects in-memory attacks:
- Process injection attempts
- Excessive memory allocations
- Interpreter-based attacks
- Living-off-the-land techniques

## Configuration

### Enable Anti-Malware Features

The malware detection is built into the core hardening module:
```bash
CONFIG_SECURITY_HARDENING=y
```

### Runtime Configuration

Adjust security levels to control anti-malware behavior:
```bash
# View current security level
cat /sys/kernel/security/hardening/status

# Set security level (requires appropriate permissions)
echo "high" > /sys/kernel/security/hardening/level
```

### Security Level Impact

| Level | Ransomware | Cryptominer | Execution Control |
|-------|------------|-------------|-------------------|
| LOW | Log only | Log only | Disabled |
| MEDIUM | Log only | Block known | Log suspicious |
| HIGH | Block suspected | Block all | Block suspicious paths |
| CRITICAL | Block aggressive | Block all | Strict blocking |
| PARANOID | Zero tolerance | Block all | Maximum restrictions |

## Usage Examples

### Monitor Malware Detection

View real-time detections:
```bash
# Watch audit logs for malware activity
dmesg | grep -i "ransomware\|miner\|malware"

# Check process statistics
cat /proc/hardening/stats | grep malware
```

### Test Ransomware Detection

**WARNING**: Only test in isolated environments!

```bash
# Simulate ransomware behavior (safe test)
for i in {1..30}; do
    echo "encrypted" > /tmp/test$i.locked
done

# Should trigger: "Possible ransomware: PID X writing high-entropy data"
```

### Whitelist Legitimate Software

Some legitimate software may trigger false positives:

```bash
# Example: Backup software doing mass operations
# Temporarily lower security level during backup
echo "medium" > /sys/kernel/security/hardening/level
run_backup_job
echo "high" > /sys/kernel/security/hardening/level
```

## How It Works

### Ransomware Detection Algorithm

1. **Time Window Tracking**: 5-second sliding window
2. **Behavioral Scoring**:
   - File modifications: +1 per file
   - High entropy writes: +5 per file
   - Suspicious renames: +10 per file
3. **Threshold Actions**:
   - Score > 20: Warning issued
   - Score > 50: Operations blocked (HIGH+ levels)

### Execution Control Flow

```
Binary Execution Request
    ↓
Check Execution Path
    ↓
/tmp or /dev/shm? → Block if HIGH+
    ↓
Hidden file (.*)?  → Log warning
    ↓
Check parent process
    ↓
Suspicious lineage? → May block
    ↓
Allow execution
```

## Performance Impact

The anti-malware features have minimal overhead:

| Feature | CPU Impact | Memory | Latency |
|---------|------------|---------|----------|
| Ransomware detection | <1% | 4KB/process | <0.1ms |
| Execution control | <0.5% | Negligible | <0.05ms |
| Cryptominer detection | <0.5% | 2KB/process | Periodic |

## Limitations

**What it CAN do:**
- Stop common ransomware patterns
- Block known cryptominers
- Prevent execution from suspicious locations
- Detect abnormal file operations

**What it CANNOT do:**
- Scan file contents for viruses
- Detect all malware variants
- Remove existing infections
- Replace dedicated antivirus software

## Best Practices

1. **Layered Security**
   - Use alongside traditional antivirus
   - Keep systems updated
   - Regular backups remain essential

2. **Tuning for Your Environment**
   - Start with MEDIUM security level
   - Monitor logs for false positives
   - Adjust thresholds if needed

3. **Response to Detections**
   - Investigate all warnings
   - Isolate suspected infected systems
   - Check process lineage for root cause

## Troubleshooting

### False Positives

**Backup software flagged as ransomware:**
- Whitelist the backup process
- Temporarily reduce security level
- Adjust thresholds in code

**Development tools blocked:**
- Compilation creates many files rapidly
- Use development directories outside /tmp
- Consider MEDIUM level for dev systems

### Debug Information

Enable verbose logging:
```bash
echo 1 > /sys/kernel/debug/hardening/debug
```

View per-process statistics:
```bash
cat /proc/<PID>/hardening/malware_stats
```

## Integration with Other Features

The anti-malware module integrates with:

- **Behavioral Analysis**: Shares syscall pattern data
- **Container Security**: Enhanced protection for containers
- **Network Monitoring**: Detects C&C communications
- **Process Lineage**: Tracks malware propagation

## Future Enhancements

Planned improvements:
- Machine learning for anomaly detection
- YARA rule integration
- Memory scanning capabilities
- Automated response actions
- Cloud threat intelligence feeds

## See Also

- [[Security-Features]] - Overview of all security features
- [[Security-Hardening-LSM-Guide]] - Complete LSM documentation
- [[Docker-Container-Security]] - Container-specific protections